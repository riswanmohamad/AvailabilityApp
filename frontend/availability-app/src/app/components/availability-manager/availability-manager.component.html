<div class="availability-container">
  <div class="header">
    <div class="header-info">
      <button class="btn btn-secondary" (click)="goBack()" type="button">
        ‚Üê Back to Dashboard
      </button>
      <div class="service-info" *ngIf="service">
        <h1>Manage Availability</h1>
        <p>{{ service.title }}<span *ngIf="service.duration"> - {{ service.duration }} minutes</span></p>
      </div>
    </div>
    <button 
      class="btn btn-primary" 
      (click)="openPatternModal()"
      type="button">
      + Add Availability Pattern
    </button>
  </div>

  <div class="content-grid">
    <!-- Availability Patterns Section -->
    <div class="patterns-section">
      <h2>Availability Patterns</h2>
      
      <div *ngIf="isLoadingPatterns" class="loading">
        Loading patterns...
      </div>

      <div *ngIf="!isLoadingPatterns && patterns.length === 0" class="empty-state">
        <h3>No availability patterns</h3>
        <p>Create your first availability pattern to define when your service is available</p>
        <button 
          class="btn btn-primary" 
          (click)="openPatternModal()"
          type="button">
          Add Pattern
        </button>
      </div>

      <div *ngIf="!isLoadingPatterns && patterns.length > 0" class="patterns-list">
        <div *ngFor="let pattern of patterns" class="pattern-card">
          <div class="pattern-header">
            <h3>{{ getPatternDisplayName(pattern) }}</h3>
            <div class="pattern-actions">
              <button 
                class="btn btn-sm btn-secondary" 
                (click)="editPattern(pattern)"
                type="button">
                Edit
              </button>
              <button 
                class="btn btn-sm btn-danger" 
                (click)="deletePattern(pattern.id)"
                [disabled]="isDeletingPattern === pattern.id"
                type="button">
                {{ isDeletingPattern === pattern.id ? 'Deleting...' : 'Delete' }}
              </button>
            </div>
          </div>
          
          <div class="pattern-details">
            <div class="detail-row">
              <span class="label">Type:</span>
              <span class="value">{{ pattern.slotType }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Duration:</span>
              <span class="value">{{ pattern.slotDuration }} minutes</span>
            </div>
            <div class="detail-row" *ngIf="pattern.startTime && pattern.endTime">
              <span class="label">Time:</span>
              <span class="value">{{ pattern.startTime }} - {{ pattern.endTime }}</span>
            </div>
            <div class="detail-row" *ngIf="pattern.daysOfWeek">
              <span class="label">Days:</span>
              <span class="value">{{ formatDaysOfWeek(pattern.daysOfWeek) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Period:</span>
              <span class="value">{{ formatDateRange(pattern.startDate, pattern.endDate) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Exceptions Section -->
    <div class="exceptions-section">
      <div class="exceptions-header">
        <h2>Exceptions</h2>
        <button 
          class="btn btn-secondary" 
          (click)="openExceptionModal()"
          type="button">
          + Add Exception
        </button>
      </div>

      <div *ngIf="isLoadingExceptions" class="loading">
        Loading exceptions...
      </div>

      <div *ngIf="!isLoadingExceptions && exceptions.length === 0" class="empty-state">
        <p>No exceptions defined</p>
        <small>Exceptions allow you to block or override availability for specific dates</small>
      </div>

      <div *ngIf="!isLoadingExceptions && exceptions.length > 0" class="exceptions-list">
        <div *ngFor="let exception of exceptions" class="exception-card">
          <div class="exception-header">
            <h4>{{ exception.title }}</h4>
            <div class="exception-actions">
              <button 
                class="btn btn-sm btn-secondary" 
                (click)="editException(exception)"
                type="button">
                Edit
              </button>
              <button 
                class="btn btn-sm btn-danger" 
                (click)="deleteException(exception.id)"
                [disabled]="isDeletingException === exception.id"
                type="button">
                {{ isDeletingException === exception.id ? 'Deleting...' : 'Delete' }}
              </button>
            </div>
          </div>
          
          <div class="exception-details">
            <p *ngIf="exception.description">{{ exception.description }}</p>
            <div class="detail-row">
              <span class="label">Type:</span>
              <span class="value">{{ exception.exceptionType }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Period:</span>
              <span class="value">{{ formatExceptionPeriod(exception) }}</span>
            </div>
            <div class="detail-row" *ngIf="exception.recurringYearly">
              <span class="value recurring">Recurring Yearly</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pattern Modal -->
  <div *ngIf="showPatternModal" class="modal-overlay" (click)="closePatternModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingPattern ? 'Edit' : 'Add' }} Availability Pattern</h3>
        <button class="close-btn" (click)="closePatternModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="patternForm" (ngSubmit)="savePattern()">
          <div class="form-row">
            <div class="form-group">
              <label for="slotType">Slot Type *</label>
              <select 
                id="slotType" 
                formControlName="slotType" 
                class="form-control"
                [class.error]="isPatternFieldInvalid('slotType')">
                <option value="">Select slot type</option>
                <option value="Minute">Minute-based</option>
                <option value="Hour">Hour-based</option>
                <option value="Day">Day-based</option>
                <option value="Week">Week-based</option>
                <option value="Month">Month-based</option>
              </select>
              <div *ngIf="isPatternFieldInvalid('slotType')" class="error-message">
                Slot type is required
              </div>
            </div>

            <div class="form-group">
              <label for="slotDuration">Duration (minutes) *</label>
              <input 
                type="number" 
                id="slotDuration"
                formControlName="slotDuration" 
                class="form-control"
                min="1"
                [class.error]="isPatternFieldInvalid('slotDuration')">
              <div *ngIf="isPatternFieldInvalid('slotDuration')" class="error-message">
                Duration is required and must be positive
              </div>
            </div>
          </div>

          <div class="form-row" *ngIf="patternForm.value.slotType === 'Minute' || patternForm.value.slotType === 'Hour'">
            <div class="form-group">
              <label for="startTime">Start Time</label>
              <input 
                type="time" 
                id="startTime"
                formControlName="startTime" 
                class="form-control">
            </div>

            <div class="form-group">
              <label for="endTime">End Time</label>
              <input 
                type="time" 
                id="endTime"
                formControlName="endTime" 
                class="form-control">
            </div>
          </div>

          <div class="form-group" *ngIf="patternForm.value.slotType === 'Minute' || patternForm.value.slotType === 'Hour'">
            <label>Days of Week</label>
            <div class="checkbox-group">
              <label *ngFor="let day of daysOfWeek" class="checkbox-label">
                <input 
                  type="checkbox" 
                  [value]="day.value"
                  [checked]="isDaySelected(day.value)"
                  (change)="toggleDay(day.value)"
                  class="checkbox">
                <span class="checkmark"></span>
                {{ day.label }}
              </label>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="startDate">Start Date *</label>
              <input 
                type="date" 
                id="startDate"
                formControlName="startDate" 
                class="form-control"
                [class.error]="isPatternFieldInvalid('startDate')">
              <div *ngIf="isPatternFieldInvalid('startDate')" class="error-message">
                Start date is required
              </div>
            </div>

            <div class="form-group">
              <label for="endDate">End Date</label>
              <input 
                type="date" 
                id="endDate"
                formControlName="endDate" 
                class="form-control">
              <small>Leave empty for ongoing availability</small>
            </div>
          </div>

          <div class="modal-actions">
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="closePatternModal()"
              [disabled]="isSubmittingPattern">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="patternForm.invalid || isSubmittingPattern">
              {{ isSubmittingPattern ? 'Saving...' : (editingPattern ? 'Update Pattern' : 'Create Pattern') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Exception Modal -->
  <div *ngIf="showExceptionModal" class="modal-overlay" (click)="closeExceptionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingException ? 'Edit' : 'Add' }} Exception</h3>
        <button class="close-btn" (click)="closeExceptionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="exceptionForm" (ngSubmit)="saveException()">
          <div class="form-group">
            <label for="exceptionTitle">Title *</label>
            <input 
              type="text" 
              id="exceptionTitle"
              formControlName="title" 
              class="form-control"
              placeholder="e.g., Vacation, Holiday, Sick leave"
              [class.error]="isExceptionFieldInvalid('title')">
            <div *ngIf="isExceptionFieldInvalid('title')" class="error-message">
              Title is required
            </div>
          </div>

          <div class="form-group">
            <label for="exceptionDescription">Description</label>
            <textarea 
              id="exceptionDescription"
              formControlName="description" 
              class="form-control"
              rows="3"
              placeholder="Optional description"></textarea>
          </div>

          <div class="form-group">
            <label for="exceptionType">Exception Type *</label>
            <select 
              id="exceptionType" 
              formControlName="exceptionType" 
              class="form-control"
              [class.error]="isExceptionFieldInvalid('exceptionType')">
              <option value="">Select type</option>
              <option value="Unavailable">Unavailable (block time)</option>
              <option value="Override">Override (change availability)</option>
            </select>
            <div *ngIf="isExceptionFieldInvalid('exceptionType')" class="error-message">
              Exception type is required
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="exceptionStartDateTime">Start Date & Time *</label>
              <input 
                type="datetime-local" 
                id="exceptionStartDateTime"
                formControlName="startDateTime" 
                class="form-control"
                [class.error]="isExceptionFieldInvalid('startDateTime')">
              <div *ngIf="isExceptionFieldInvalid('startDateTime')" class="error-message">
                Start date and time is required
              </div>
            </div>

            <div class="form-group">
              <label for="exceptionEndDateTime">End Date & Time *</label>
              <input 
                type="datetime-local" 
                id="exceptionEndDateTime"
                formControlName="endDateTime" 
                class="form-control"
                [class.error]="isExceptionFieldInvalid('endDateTime')">
              <div *ngIf="isExceptionFieldInvalid('endDateTime')" class="error-message">
                End date and time is required
              </div>
            </div>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                formControlName="recurringYearly"
                class="checkbox">
              <span class="checkmark"></span>
              Recurring yearly (e.g., for holidays)
            </label>
            <small class="form-help">
              This exception will automatically apply to the same dates every year
            </small>
          </div>

          <div class="modal-actions">
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="closeExceptionModal()"
              [disabled]="isSubmittingException">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="exceptionForm.invalid || isSubmittingException">
              {{ isSubmittingException ? 'Saving...' : (editingException ? 'Update Exception' : 'Create Exception') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>